{% extends 'base_lab_layout.html' %}
{% load render_table from django_tables2 %}
{% load querystring from django_tables2 %}
{% load crispy_forms_tags %}
{% block extrahead %}
    {{ form.media }}
{% endblock %}


{% block dashboard %}
    {% render_table labo %}
    {#     Automatic sample reception at the lab bypass previous manual method #}
    <form method="post" action="" id="post-auto">
        {% csrf_token %}
    </form>

    <div class="modal fade" id="modal-default">
        <div class="modal-dialog">
            <div class="modal-content bg-gradient-dark">
                <div class="modal-header">
                    <h4 class="modal-title"><b>Enregistrement de l'échantillon</b></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                 <form method="post" action="" id="post-form">
                     <div id="success-change">
                         <div class="modal-body">

                             {% csrf_token %}
                    {% crispy form %}
            </div>

            <div id="submit-control" class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
              <button type="button" class="btn btn-primary">Enregistrer</button>
            </div>
                      </div>
{#                <script>#}
{#        $(function () {#}
{#            $("#id_date").datepicker({#}
{#                format: 'dd/mm/yyyy',#}
{#            });#}
{#        });#}
{#    </script>#}
              </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
{% endblock %}


{% block reception %}
    {% render_table labo1 %}

    <div class="modal fade" id="modal-modifier">
        <div class="modal-dialog">
            <div class="modal-content bg-gradient-dark">
                <div class="modal-header">
                    <h4 class="modal-title">Modification de l'échantillon</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" action="" id="modification-form">
                    <div id="success-change1">

                        <div class="modal-body">
                    {% csrf_token %}
                    {% crispy form1 %}
            </div>
            <div id="submit-control1" class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
              <button type="button" class="btn btn-warning">Enregistrer</button>
            </div>
{#                <script>#}
{#        $(function () {#}
{#            $("#id_date").datepicker({#}
{#                format: 'dd/mm/yyyy',#}
{#            });#}
{#        });#}
{#    </script>#}
                                    </div>
              </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
{% endblock %}


<script>
{% block javascript %}


        // using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    //script for submitting data in ajax posting echantillon
    $('.btn.btn-danger').click(function (e) {
        e.preventDefault()
        //Disable submit button
        Id = $(this).data('id'); //getting the id of the row which equal to the pk into the database
        console.log(Id); //Sanity Check
        var pk = Id;
        var APIurl = "{% url 'reception' %}";
        $input = $('<input type="hidden" name="pk">').val(pk);
        $('#post-auto').append($input);
        var SerializedData = $("#post-auto").serialize();
        console.log(SerializedData); //sanity check
        $.ajax({
            url: APIurl,
            type: "POST",
            data: SerializedData,
            dateType: 'json',
            success: function () {
                location.reload();
            }
        })

    });

    $('.btn.btn-primary').click(function (e) {
        e.preventDefault()
        //Disable Submit button
        $('.btn.btn-primary').attr("disabled", true);
        var pk = Id;
        var APIurl = "{% url 'reception' %}";
        $input = $('<input type="hidden" name="pk">').val(pk);
     $('#post-form').append($input);
     var SerializedData = $("#post-form").serialize();
     console.log(SerializedData);
     $.ajax({
         url: APIurl,
         type: "POST",
         data: SerializedData,
         dataType: 'json',
         success: function () {
             $('#success-change').html("<div class=\"modal-body\"><div class=\"alert alert-success\" role=\"alert\">\n" +
                 " Données Sauvegardées " +
                 "</div></div><div class=\"modal-footer justify-content-between\">\n" +
                 "              <button type=\"button\" class=\"btn btn-danger\" onClick=\"window.location.reload();\" data-dismiss=\"modal\">Fermer</button>\n" +
                 "            </div>")
         },

         error: function () {
             console.log('Erreur');
             alert('Veuillez completer tous les champs obligatoires !');
             $('.btn.btn-primary').attr("disabled", false);
             location.reload();
         }
     });
    })


    $('.btn.btn-warning').click(function (e) {
        e.preventDefault()
        var pk = Id;
        var APIurl = "{% url 'modification' %}";
        $input = $('<input type="hidden" name="pk">').val(pk);
        $('#modification-form').append($input);
        var SerializedData = $("#modification-form").serialize();
        console.log(SerializedData);
        $.ajax({
            url: APIurl,
            type: "POST",
            data: SerializedData,
            success: function () {
                $('#success-change1').html("<div class=\"modal-body\"><div class=\"alert alert-success\" role=\"alert\">\n" +
                       " Données Sauvegardées " +
                       "</div></div><div class=\"modal-footer justify-content-between\">\n" +
                       "              <button type=\"button\" class=\"btn btn-danger\" onClick=\"window.location.reload();\" data-dismiss=\"modal\">Fermer</button>\n" +
                       "            </div>")
                },
            });
                })



    {% endblock %}
</script>
